#!/bin/env node

var LDAP = require('ldap-client')
  , connect = require('config').ldap.connect
  , ldapClient = new LDAP(connect)
  , ldap = require('ldap')
  , mongo = require('config').mongo
  , MongoClient = require('mongodb').MongoClient
  ;

var dbURI = 'mongodb://' +
    mongo.dbuser +
    ':' +
    mongo.dbpass +
    '@' +
    mongo.host +
    ':' +
    mongo.port +
    '/' + mongo.dbname;


MongoClient.connect(dbURI, function(e,db) {
  var DB = db;
  ldap.init(ldapClient);

  ldap.validate(DB, 'kuku@wwmm.org', '1234', function(r){
    console.log(r);
    ldap.close();
    DB.close();
  });
});
/*
//      binddn: kuku + ',' + ldap.connect.base,
var kuku = 'cn=kuku@wwmm.org'
  , kukuBind = {
      binddn: kuku + ',' + ldap.connect.base, 
      password: '1234'
    };

//ldap.connect.filter = kuku;

ldap.confirm('kuku@wwmm.org', '1234', function(e, r){
  if(e){console.log(e)}
  console.log(r);
  ldap.close();
});
*/

/*
ldap.authenticate('kuku@wwmm.org', '1234', function(e, data){
  if(e){console.log(e)}
  if(data){console.log(data)};
  ldap.close();
});

ldap.add('dima@wwmm.org','1111','10000010002',function(e,r){
  if(e){console.log(e)}
  console.log(r);
  ldap.close();
});
  ldap.updateMail('dima@wwmm.org','dima@gmail.com',function(e,r){
    if(e){console.log(e)}
    console.log(r);
    ldap.close();
  });
    ldap.updatePassword('dima@gmail.com','1111', '1234', function(e,r){
      if(e){console.log(e)}
      console.log(r);
      ldap.close();
    });

      ldap.authenticate('dima@gmail.com', '1234', function(e, data){
        if(e){console.log(e)}
        if(data){console.log(data)};
        ldap.close();
      });


ldap.remove('dima@gmail.com',function(e,r){
  if(e){console.log(e)}
  console.log(r);
  ldap.close();
});

*/



/*


//console.log(ldap.connect);
//console.log(kukuBind);

var test = function(b, fn){
  var b = b || {};  
  var ldapClient = new LDAP(ldap.connect);
  ldapClient.bind(b, function(e){fn(e,e===undefined,ldapClient)});
}

test(kukuBind, function(e,r,l){
if(e){console.log(e)};
console.log(r);
l.close();
});
//console.log(ldap);
//console.log(oo);
//ldapClient.bind(kuku + ',' + ldap.ou, '1234', function(e,r){console.log(r); ldapClient.unbind();});
//
*/

