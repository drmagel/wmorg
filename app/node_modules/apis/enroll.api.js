exports.enroll = function(req, res){
  var api = 'enroll'
    , body = {};
  if(req.headers.auth === undefined ||
     req.headers.auth !== api){return res.end();}

  var email = req.body.email || '';
  var lang = req.body.lang || '';
  if(email === '' || lang === ''){return res.end()};
  res.set('Content-Type', 'application/json');
  res.set('Auth', api);
//------------------------------------------------------

  users.verify(email,function(e,r){
    if(e){return res.status(500).json({error: "API:"+api+": "+e})};
    if(r.length){
      body = r[0];
      body.result = false;
      body.reason = 'already_exists';
      return res.json(body);
    } else {
      var verStr = Math.random().toString(26).replace(/[^a-z]+/g, '').substr(1,8)
        , verNum = Math.random().toString().replace(/[^\d]+/g, '').substr(1,8)
        ;
      body.email = email;
      smtp.sendMail(registrationMail(lang, email, verStr, verNum), function(e,r){
        if(e){
          body.result = false;
          body.reason = 'non_existent_email';
          return res.json(body);
        };
        body.number = verNum;
        body.string = verStr;
        body.result = true;
        return res.json(body);
      });  
    }
  });
}

