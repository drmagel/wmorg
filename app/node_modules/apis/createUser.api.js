exports.createUser = function(req, res){
  var api = 'createuser'
    , body = {};
  if(req.headers.auth === undefined ||
     req.headers.auth !== api){return res.end();}
  res.set('Content-Type', 'application/json');
//------------------------------------------------------
  var User = req.body.user || {}
    , passwd = req.body.password || ''
    , email = req.body.email || ''
    , verNum = req.body.number || 0
    , verStr = req.body.string || ''
    , userID = 0
    ;

  if( Object.keys(User).length === 0 ||    
      passwd === '' ||
      email === '' ||
      verNum === 0 ||
      verStr === ''
    ){return res.end();}

  User.userStatus = 'active';
  User.userRole = [];
  User.userRating = {score: 0, evaluations: 0};
  User.pictureURL = '';
  User.registrationDate = new Date().getTime();
  User.email = email;
  User.groupAdminUserID = 0;

  enrolls.get({email: email, number: verNum, string: verStr}, function(e,r){     
    if(e){return res.status(500).json({error: "API:"+api+": "+e})};
    if(!!!r){return res.end();}     
    count.get('userID', function(e,r){
      if(e){return res.status(500).json({error: "API:"+api+": "+e})};
      userID = r.value.seq;
      ldap.add(email, passwd, userID, function(e,r){
        if(e){return res.status(500).json({error: "API:"+api+": "+e})};
        User.userID = userID;
        users.insert(User, function(e,r){
          if(e){return res.status(500).json({error: "API:"+api+": "+e})};
          delete User._id;
          body.userID = userID;
          session.insert(body, function(e,r){
            if(e){return res.status(500).json({error: "API:"+api+": "+e})};
            enrolls.remove(email);
            delete body._id;
            body.result = true;
//            body.user = User;
            res.set('Auth', body.sessID);
            res.json(body); // response {sessID, userID, result}
          }); // session
        }); // users
      }); // ldap
    }); // count
  }); // enrolls
}

