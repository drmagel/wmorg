exports.operateGroup = function(req, res){
  var api = 'operateGroup'
    , sessID = req.headers.auth
    , operand = req.query.operand ? req.query.operand : req.body.operand || ''
    , userID = Number(req.body.userID) || 0
    , body = {};
  if ( sessID === undefined ||
       sessID !== req.body.sessID ||
       userID === 0 ||
       operand === '' ) {return res.end()};
  res.set('Content-Type', 'application/json');
  res.set('Auth', sessID);
  body.sessID = sessID;
//------------------------------------------------------

  var d = new Date()
    , permissions = ['groupAdmin'] // Required permissions for the API execution
    ;

  //19
  session.get(sessID,{userID:1, validTill:1}, function(e,r){ // session validation
    if(e){return res.status(500).json({error: "API:"+api+":session validation: "+e})};
    if(r === null || r.userID !== userID){ // no sessID or different userID
      body.result = false;
      body.reason = 'invalid_sessid';
      res.json(body);
    } else if(r.validTill < d.getTime()) { // sessID is expired
      body.result = false;
      body.reason = 'sessid_expired';
      res.json(body);
    } else { // sessID is OK
      users.get(userID, {'userRole':1}, function(e,r){
        if(e){return res.status(500).json({error: "API:"+api+":user role: "+e})};
        if(r.userRole.some(function(el){return permissions.indexOf(el) > -1;})){ // user has permission
          switch(operand){
            case 'updateProfile':
              var data = req.body.data || {};
              if(!Object.keys(data).length){return res.end()};
              groupadmin.update(userID, data, function(e,r){
                if(e){return res.status(500).json({error: "API:"+api+":groupadmin update: "+e})};
                groupadmin.get(userID, {}, function(e,r){
                  if(e){return res.status(500).json({error: "API:"+api+":groupadmin get: "+e})};
                  body.groupadmin = r;                  
                  body.result = true;
                  return res.json(body);
                }); // groupadmin.get()
              }); // groupadmin.update()
            break; // updateProfile
            case 'listGroup':
              groupadmin.get(userID, {members:1}, function(e,r){
                if(e){return res.status(500).json({error: "API:"+api+":groupadmin get: "+e})};                
                if(!r){return errResponse(reason.roleError, body, res)};
                users.getList(r.members, {groupAdminUserID:0, bankAccount:0}, function(e, lst){
                  if(e){return res.status(500).json({error: "API:"+api+":users getList: "+e})};                
                  body.members = lst;
                  body.result = true;
                  return res.json(body);
                }); // users.getList()
              }); // groupadmin.get()
            break; // listGroup
//            case '':
//            break; // 
            default:
              res.status(500).json({error: "API:"+api+": Operand "+operand+" is not supported"});
          } // switch
        } else { // user doesn't have permission
          return errResponse(reason.permissionDenied, body, res)
        }
      }); // users.get()
// 2
    } // if-else
  }); // session validation
}
