"use strict";var wmoControllers=angular.module("wmoControllers",[]);wmoControllers.controller("BootStrapCtrl",["rootScope","$scope","$location","LangMngr",function(e,n,t,a){var o=t.path;n.setLang=function(e){a.setLang(e),t.path(o).replace()},n.carousel=function(e,n){$(e).carousel(n)},n.tab=function(e){console.log("BOOTSTRAP:: TAG: "+e),$(e).tab("show")}}]),wmoControllers.controller("CreatePlanCtrl",["$window","$location","$scope","$rootScope","Calendar","OperatePlan","ValidateByPassword",function(e,n,t,a,o,r,s){t.plan={description:{}},t.newPlans=[],t.disableEditing=!0,t.dateFormat=$PLANPROPERTIES.planDateFormat;var l=e.sessionStorage.getItem("userID")||"",i=e.sessionStorage.getItem("sessID")||"";t.localTime=function(e){return o.local(e)},t.cleanPlan=function(){t.plan={description:{}},t.planPropertiesTmpl=a.planPropertiesTmpl+"?r="+Math.random()},t.addPlan=function(){t.newPlans.push(t.plan),t.cleanPlan()},t.editPlan=function(e){t.disableEditing=!1,t.plan=JSON.parse(JSON.stringify(t.newPlans[e])),t.planPropertiesTmpl=a.planPropertiesTmpl+"?r="+Math.random()},t.removePlan=function(e){t.newPlans.splice(e,1)},t.doneEditing=function(){var e=t.plan;t.disableEditing=!0,t.newPlans[e.ind]=e,t.cleanPlan()},t.addPlanValidation=function(){var e=t.plan,n=e.description;return!(e.fromDate>0&&(e.tillDate>0||"permanent"===e.tillDate)&&e.duration>0&&e.interest>0&&n.constructor===Object&&Object.keys(n).length>0)},t.createInSystem=function(){s.validate("newPlanCreation","cancel",function(){var e=t.newPlans.length;t.newPlans.forEach(function(a){delete a.ind,0==--e&&r.create({plan:t.newPlans,userID:l,sessID:i},function(e){if(t.newPlans=[],e.result)s.response("success","operationSuccess");else switch(e.reason){case"invalid_sessid":s.response("failure","invalidSession",function(){n.path($LOGOUT).replace()});break;case"permission_denied":s.response("failure","permissionDenied",function(){n.path($LOGOUT).replace()})}})})},function(){})}}]),wmoControllers.controller("CreateUserCtrl",["$window","$rootScope","$scope","$routeParams","$location","$uibModal","CreateUser","FilterSortTranslated","Enroll",function(e,n,t,a,o,r,s,l,i){var c=$LOGIN,u=$USERS,d=$REGISTER,p=!1,m=["passwd","personalDetails","bankAccounts","submit"],f=Number(a.step);t.disabled=function(){switch(m[f]){case"passwd":return t.validatePasswd&&(n.password=t.password),!((n.password||"").length>0&&n.password===t.passConfirm);case"personalDetails":return!((n.user.firstName||"").length>0&&(n.user.familyName||"").length>0&&(n.user.city||"").length>0&&"ok"===t.phoneIsValid());case"bankAccounts":return!((n.user.bankAccounts||[]).length>0);default:return!1}};var g=function(){var a=n.user,r=n.password,l=n.email;s.get({email:l,password:r,user:a},function(a){return a.result&&(e.sessionStorage.setItem("sessID",a.sessID),e.sessionStorage.setItem("userID",a.userID),u=u+a.userID+"/"+a.sessID,o.path(u).replace(),delete n.password,n.user={}),t.response=a})};n.email=e.sessionStorage.getItem("email"),n.user=n.user||{language:n.lang.lang},n.userPhone=n.userPhone||"",t.bankAccounts=n.user.bankAccounts||[],t.cityInput=n.user.city?n.lang.tr(n.user.city):"",t.countries=Object.keys($COUNTRIES),t.password="",t.class={phoneNumberClass:""},t.phoneAlertMessage="phone_already_exists",t.validatePasswd=function(){return passwdValidateRE.test(t.password)},t.validatePhoneNumber=function(){return phoneNumberValidateRE.test(n.user.phone)},t.showPhoneAlert=function(){return p},t.dismissPhoneAlert=function(){p=!1,delete n.user.phone,t.class.phoneNumberClass=""},t.phoneIsValid=function(){return n.userPhone===n.user.phone?"ok":!p&&t.validatePhoneNumber()&&n.userPhone!==n.user.phone?"alert":t.validatePhoneNumber()||p?"continue":"usage"},t.enrollPhoneNumber=function(){i.checkPhone({phone:n.user.phone},function(e){e.result?(p=!1,n.userPhone=n.user.phone):(n.userPhone="",p=!0,t.phoneAlertMessage=e.reason||"no_reason")})},t.setCountry=function(e){var e=e||n.user.country||t.countries[0];t.country=e,t.countryCode=$COUNTRIES[e].countryCode,t.phoneExample=$COUNTRIES[e].phoneExample,t.currency=n.lang.tr($COUNTRIES[e].currency.name)+"    "+$COUNTRIES[e].currency.sign,t.cities=$COUNTRIES[e].cityList,n.user.country=e,n.user.currency=$COUNTRIES[e].currency.value},t.setCity=function(e){t.cityInput=n.lang.tr(e),n.user.city=e},t.cityList=function(e){return l($COUNTRIES[t.country].cityList,e)},t.openBankAccountManager=function(e){r.open({animation:!0,keyboard:!0,backdrop:"static",templateUrl:$TMPL+"manageBankAccount.html",controller:"ModalManageBankAccountCtrl",size:"md",resolve:{bankAccounts:function(){return t.bankAccounts},country:function(){return n.user.country},openValue:function(){return e||""}}}).result.then(function(e){n.user.bankAccounts=e.concat()},function(){})},t.nextStr=f===m.length-1?"submit":"next",t.backStr=0===f?"cancel":"back",t.show=function(e){return f===m.indexOf(e)},t.next=function(){var e=f+1;e<=m.length-1?o.path(d+e).replace():g()},t.back=function(){var e=f-1;e<0?o.path(c).replace():o.path(d+e).replace()}}]),wmoControllers.controller("EnrollCtrl",["$window","$scope","$rootScope","$uibModal","$location","Enroll",function(e,n,t,a,o,r){n.enroll=function(t){var a=e.sessionStorage.getItem("lang")||"eng";r.checkEmail({email:t,lang:a},function(e){return e.result&&n.openModal(),n.response=e})},n.openModal=function(){a.open({animation:!0,keyboard:!0,backdrop:"static",templateUrl:$TMPL+"enroll.html",controller:"ModalEnrollCtrl",size:"md",resolve:{Email:function(){return n.email}}}).result.then(function(n){e.sessionStorage.setItem("email",n),o.path($REGISTER+$START).replace()},function(){e.sessionStorage.setItem("email","")})},n.showAlert=function(){return void 0!==(n.response||{}).reason&&(n.response.reason&&(n.inputChanged=!1),!!n.response.reason)},n.dismissAlert=function(){return delete n.email,n.response.reason=!1},n.alertMessage=function(){return(n.response||{}).reason||"no_reason"},n.changed=function(){return n.inputChanged=!0},n.disabled=function(){return!(n.email&&n.inputChanged)}}]),wmoControllers.controller("GetPlansCtrl",["$window","$scope","$rootScope","$location","GetPlans","Calendar","ValidateByPassword","OperatePlan",function(e,n,t,a,o,r,s,l){var i=t.operand,c=r.today(),u=e.sessionStorage.getItem("userID")||"",d=e.sessionStorage.getItem("sessID")||"",p={getActive:"activePlans",getCompleted:"completedPlans",getPending:"pendingPlans",getPermanent:"permanentPlans",getAll:"allPlans"};n.plan={description:{}},n.editPlan=!1,n.dateFormat=$PLANPROPERTIES.planDateFormat,n.plansToDelete=n.plansToDelete||[],n.planList=n.planList||[],n.getPlanList=function(){o[i]({userID:u,sessID:d},function(e){if(e.result)n.planList=e.plans;else switch(e.reason){case"sessid_expired":s.validate("sessionExpired","logout",function(){o[i]({userID:u,sessID:d},function(e){n.planList=e.plans})},function(){a.path($LOGOUT).replace()});break;case"invalid_sessid":s.response("failure","invalidSession",function(){a.path($LOGOUT).replace()})}})},n.localTime=function(e){return r.local(e)},n.getPageHeader=function(){return p[i]},n.checkboxToDelete=function(e,t){var a=n.planList[t].planID;if(e)return n.plansToDelete.push(a);n.plansToDelete=n.plansToDelete.filter(function(e){return e!==a})},n.showTrashTD=function(){return n.planList.filter(function(e){return e.fromDate>c}).length>0},n.disableCheckbox=function(e){return n.planList[e].fromDate<=c},n.cleanToDelete=function(){n.cleanDelete=!1,n.plansToDelete=[]},n.deleteFromSystem=function(){s.validate("removingPlans","cancel",function(){l.remove({planID:n.plansToDelete,userID:u,sessID:d},function(e){if(n.plansToDelete=[],n.cleanDelete=!1,e.result)o[i]({userID:u,sessID:d},function(e){n.planList=e.plans}),s.response("success","operationSuccess");else switch(e.reason){case"invalid_sessid":s.response("failure","invalidSession",function(){a.path($LOGOUT).replace()});break;case"permission_denied":s.response("failure","permissionDenied",function(){a.path($LOGOUT).replace()})}})},function(){})},n.editPlan=function(e){n.plan=JSON.parse(JSON.stringify(n.planList[e])),n.planEditing=!0,n.planPropertiesTmpl=t.planPropertiesTmpl+"?r="+Math.random()},n.cancelEditing=function(){n.planEditing=!1,n.plan={description:{}}},n.doneEditing=function(){var e=n.plan;delete e.ind,s.validate("updatingPlan","cancel",function(){l.update({plan:e,userID:u,sessID:d},function(e){if(n.plansToDelete=[],n.cleanDelete=!1,e.result)n.planEditing=!1,n.plan={description:{}},o[i]({userID:u,sessID:d},function(e){n.planList=e.plans}),s.response("success","operationSuccess");else switch(e.reason){case"invalid_sessid":s.response("failure","invalidSession",function(){a.path($LOGOUT).replace()});break;case"permission_denied":s.response("failure","permissionDenied",function(){a.path($LOGOUT).replace()})}})},function(){})}}]),wmoControllers.controller("LoginCtrl",["$window","$scope","$location","Login",function(e,n,t,a){var o=$USERS;n.login=function(r,s){a.get({email:r,password:s},function(a){return a.result&&(e.sessionStorage.setItem("sessID",a.sessID),e.sessionStorage.setItem("userID",a.userID),e.sessionStorage.setItem("email",r),o=o+a.userID+"/"+a.sessID,t.path(o).replace()),n.response=a})},n.showAlert=function(){return void 0!==(n.response||{}).reason&&(n.response.reason&&(n.inputChanged=!1),!!n.response.reason)},n.dismissAlert=function(){return delete n.password,n.response.reason=!1},n.alertMessage=function(){return(n.response||{}).reason||"no_reason"},n.changed=function(){return n.inputChanged=!0},n.disabled=function(){return!(n.email&&n.password&&n.inputChanged)}}]),wmoControllers.controller("LogoutCtrl",["$window","$location","$rootScope","Logout",function(e,n,t,a){var o=e.sessionStorage.getItem("sessID");a.get({sessID:o},function(a){e.sessionStorage.setItem("sessID",""),e.sessionStorage.setItem("userID",""),e.sessionStorage.setItem("email",""),delete t.user,n.path($LOGIN).replace()})}]),wmoControllers.controller("ModalEnrollCtrl",["$scope","$rootScope","$uibModalInstance","Enroll","Email",function(e,n,t,a,o){var r=o,s=!1;e.input={verNumber:"",verString:"",verNumberClass:"",verStringClass:""},e.validateNumber=function(){return e.input.verNumber.match(/^[0-9]{8}$/)},e.validateString=function(){return e.input.verString.match(/^[a-z]{8}$/)},e.disabled=function(){return!(e.validateString()&&e.validateString()&&!e.hideInput)},e.showAlert=function(){return s},e.dismissAlert=function(){s=!1,e.input.verNumber="",e.input.verString="",e.input.verNumberClass="",e.input.verStringClass=""},e.register=function(){a.reassert({email:r,number:e.input.verNumber,string:e.input.verString},function(e){e.result?t.close(r):s=!0})},e.cancel=function(){t.dismiss("canceled")}}]),wmoControllers.controller("ModalLogoutCtrl",["$scope","$uibModalInstance",function(e,n){e.logout=function(){n.close("logout")},e.cancel=function(){n.dismiss("canceled")}}]),wmoControllers.controller("ModalManageBankAccountCtrl",["$scope","$uibModalInstance","FilterSortTranslated","bankAccounts","country","openValue",function(e,n,t,a,o,r){var o=o,r=r,s={};e.bankAccounts=a,e.btnName="add",e.removeBankAccount=function(n){e.bankAccounts.splice(n,1)},e.createBankList=function(){e.bankList=t($COUNTRIES[o].bankList),e.bankName=s.bank=e.bankList[0]};var l=function(n){return function(){e.bankAccounts[n]=JSON.parse(JSON.stringify(s)),e.cleanAndClose()}},i=function(){e.bankAccounts.push({bank:s.bank,branch:s.branch,account:s.account,accountOwner:s.accountOwner}),e.cleanAndClose()},c=function(){return!(s.branch&&s.account&&s.accountOwner)};e.setBankName=function(e){s.bank=e},e.setBankBranch=function(e){s.branch=e},e.setBankAccount=function(e){s.account=e},e.setAccountOwner=function(e){s.accountOwner=e},e.editBankAccout=function(n){s=JSON.parse(JSON.stringify(e.bankAccounts[n])),e.bankName=s.bank,e.bankBranch=s.branch,e.bankAccount=s.account,e.accountOwner=s.accountOwner,e.bankAccountFormTmpl="BankAccountFormTmpl.html",e.btnFunction=l(n),e.disabledAdd=function(){return!1},e.btnSign="ok",e.btnClass="primary"},e.addBankAccount=function(){e.bankAccountFormTmpl="BankAccountFormTmpl.html",e.btnFunction=i,e.disabledAdd=c,e.btnSign="plus",e.btnClass="success"},e.cleanAndClose=function(){delete e.bankName,delete e.bankBranch,delete e.bankAccount,delete e.accountOwner,delete e.bankAccountFormTmpl,s={}},e.isFormOpened=function(){return!!e.bankAccountFormTmpl},e.initAddAccount=function(){"add"===r&&e.addBankAccount()},e.disabled=function(){return 0===e.bankAccounts.length},e.done=function(){n.close(e.bankAccounts)},e.cancel=function(){n.dismiss("canceled")}}]),wmoControllers.controller("ModalOperationResponseCtrl",["$scope","$uibModalInstance","modalHeader","modalStatus",function(e,n,t,a){switch(e.operModal={title:t},a){case"success":e.operModal.glyphicon="glyphicon-ok-circle",e.operModal.alert="alert-success";break;case"failure":e.operModal.glyphicon="glyphicon-ban-circle",e.operModal.alert="alert-danger"}e.close=function(){n.close("confirmed")},e.cancel=function(){n.dismiss("canceled")}}]),wmoControllers.controller("ModalValidateByPasswordCtrl",["$window","$scope","$uibModalInstance","Validate","modalHeader","modalCancel",function(e,n,t,a,o,r){n.modalHeader=o,n.modalCancel=r;var s=function(){return passwdValidateRE.test(n.data.password)},l={},i=!0,c=e.sessionStorage.getItem("email"),u=e.sessionStorage.getItem("sessID");n.data={email:c,sessID:u},n.showAlert=function(){return void 0!==l.reason&&(l.reason&&(i=!1),!!l.reason)},n.dismissAlert=function(){return delete n.data.password,l.reason=!1},n.alertMessage=function(){return"invalid_credentials"===l.reason&&(l.reason="wrong_password"),l.reason||"no_reason"},n.changed=function(){return i=!0},n.disabled=function(){return!(s()&&i)},n.confirm=function(){a.get(n.data,function(e){return e.result&&t.close("confirmed"),l=e})},n.cancel=function(){t.dismiss("canceled")}}]),wmoControllers.controller("PlanPropertiesCtrl",["$scope","$rootScope","Calendar","LangMngr",function(e,n,t,a){var o=t.today(),r=$PLANPROPERTIES.pendingStartPeriod,s=$PLANPROPERTIES.pendingFinishPeriod,l=$PLANPROPERTIES.minActivePeriod,i=l,c=$PLANPROPERTIES.maxPlanDuration,u=$PLANPROPERTIES.maxPlanPercentage;e.percentageLength=5,e.maxPlanDuration=c,e.tillDateInput="init",e.minFromDate=r,e.minTillDate=r+l,e.setInputLang=function(){e.dr={},$LANGS.forEach(function(n){var t=n.value,o=a.getDirection(t);e.dr[t]={},e.dr[t].Dir=o,e.dr[t].FltDir=a.getFloatDirection(o),e.dr[t].OppFltDir=a.getOppositeFloatDirection(o)})},void 0===e.plan.fromDate?(e.fromDate=t.yyyyMMdd(t.addDays(o,r),"-"),e.plan.fromDate=t.utc(e.fromDate).getTime()):(e.fromDate=t.yyyyMMdd(e.plan.fromDate,"-"),e.tillDate=t.yyyyMMdd(t.addDays(e.fromDate,l),"-")),void 0===e.plan.tillDate?(e.tillDate=t.yyyyMMdd(t.addDays(o,r+l),"-"),e.plan.tillDate=t.utc(e.tillDate).getTime()):(e.minTillDate=function(){var n=e.plan.fromDate;return n<=o?t.dayPeriod(n,o)>l?s:l+s-t.dayPeriod(n,o):t.dayPeriod(o,n)+l}(),"permanent"===e.plan.tillDate?(e.tillDateInput="unlimited",e.tillDate=t.yyyyMMdd(t.addDays(o,e.minTillDate),"-")):(e.tillDateInput="date",e.tillDate=t.yyyyMMdd(e.plan.tillDate,"-"),i=t.dayPeriod(e.plan.fromDate,e.plan.tillDate))),e.setFromDate=function(n){var n=t.utc(n),a=t.addDays(n,l);e.plan.fromDate=n.getTime(),e.minTillDate=l+t.dayPeriod(o,n),e.tillDateInput="init",i>0&&(a=t.addDays(n,i)),e.tillDate=t.yyyyMMdd(a,"-")},e.setTillDate=function(n){var n=t.utc(n);e.plan.tillDate=n.getTime(),i=t.dayPeriod(e.plan.fromDate,e.plan.tillDate)},e.setTillDateInput=function(n){e.tillDateInput=n,"unlimited"===n&&(e.plan.tillDate="permanent"),"date"===n&&(e.plan.tillDate=t.utc(e.tillDate).getTime())},e.validatePercentage=function(n){return 0===n.length&&(e.percentageLength=5),n.match(/,$/)&&(n=n.replace(/,$/,".")),n.match(/^\./)&&(n=n.replace(/^\./,"0."),e.percentageLength=4),n.match(/\..*\.$/)&&(n=n.slice(0,-1)),n.match(/[\d\.]$/)||(n=n.slice(0,-1)),Number(n)>u&&(n=n.slice(0,-1)),n},e.validateDuration=function(e){return e.match(/[\d]$/)||(e=e.slice(0,-1)),(Number(e)<1||Number(e)>c)&&(e=e.slice(0,-1)),e},e.enableProperties=function(){return void 0===e.plan.fromDate||void 0===e.plan.tillDate||e.plan.fromDate>o},e.enableActivePeriod=function(){return void 0===e.plan.fromDate||void 0===e.plan.tillDate||("permanent"===e.plan.tillDate||e.plan.tillDate>o)},e.disableFromDate=function(){return void 0!==e.plan.fromDate&&e.plan.fromDate<=o}}]),wmoControllers.controller("setLangCtrl",["$rootScope","$scope","LangMngr",function(e,n,t){e.lang=t.init(),e.setLang=function(e){t.setLang(e)},n.langs=$LANGS,n.langsBar=function(){var n;return $LANGS.forEach(function(t){t.value===e.lang.lang&&(n=t.name)}),n.slice(0,3)}}]),wmoControllers.controller("UserHomeCtrl",["$location","$window","$routeParams","$rootScope","$scope","$uibModal","GetUser","ValidateByPassword",function(e,n,t,a,o,r,s,l){var i=t.userid||"",c=t.sessid||"";o.userID=n.sessionStorage.getItem("userID")||"",o.sessID=n.sessionStorage.getItem("sessID")||"",o.userID.length>0&&o.sessID.length>0&&i===o.userID&&c===o.sessID||e.path($LOGOUT).replace();var u=function(){s.get({userID:o.userID,sessID:o.sessID},function(n){if(n.result)a.user=n.user,o.currencySign=$COUNTRIES[a.user.country].currency.sign;else switch(n.reason){case"invalid_sessid":e.path($LOGOUT).replace();break;case"sessid_expired":l.validate("sessionExpired","logout",function(){s.get({userID:o.userID,sessID:o.sessID},function(e){a.user=e.user,o.currencySign=$COUNTRIES[a.user.country].currency.sign})},function(){e.path($LOGOUT).replace()})}return o.response=n})},d={init:"LoanCollect",userInfo:"UserInfo",loanCollect:"LoanCollect",createPlan:"CreatePlan",getPlans:"GetPlans",test:"test"},p=function(e,n){var n=n||"";o.userHomeIncludeURL=$UHTMPL+d[e]+".html",n.length>0&&(o.userHomeIncludeURL+="?operand="+n+"&r="+Math.random(),a.operand=n)};o.setIncludeURL=p,o.initUserHome=function(){0===((a.user||{}).userID||"").length&&u(),0===(o.userHomeIncludeURL||"").length&&p("init")},o.logout=function(){r.open({animation:!0,keyboard:!0,backdrop:"static",templateUrl:$TMPL+"logout.html",controller:"ModalLogoutCtrl",size:"sm",resolve:{}}).result.then(function(){e.path($LOGOUT).replace()},function(){})}}]);