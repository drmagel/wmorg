"use strict";var wmoControllers=angular.module("wmoControllers",[]);wmoControllers.controller("BootStrapCtrl",["rootScope","$scope","$location","LangMngr",function(a,b,c,d){var e=c.path;b.setLang=function(a){d.setLang(a),c.path(e).replace()},b.carousel=function(a,b){$(a).carousel(b)},b.tab=function(a){console.log("BOOTSTRAP:: TAG: "+a),$(a).tab("show")}}]),wmoControllers.controller("CreatePlanCtrl",["$window","$location","$scope","$rootScope","Calendar","OperatePlan","ValidateByPassword",function(a,b,c,d,e,f,g){c.plan={description:{}},c.newPlans=[],c.disableEditing=!0,c.dateFormat=$PLANPROPERTIES.planDateFormat;var h=a.sessionStorage.getItem("userID")||"",i=a.sessionStorage.getItem("sessID")||"";c.localTime=function(a){return e.local(a)},c.cleanPlan=function(){c.plan={description:{}},c.planPropertiesTmpl=d.planPropertiesTmpl+"?r="+Math.random()},c.addPlan=function(){c.newPlans.push(c.plan),c.cleanPlan()},c.editPlan=function(a){c.disableEditing=!1,c.plan=JSON.parse(JSON.stringify(c.newPlans[a])),c.planPropertiesTmpl=d.planPropertiesTmpl+"?r="+Math.random()},c.removePlan=function(a){c.newPlans.splice(a,1)},c.doneEditing=function(){var a=c.plan;c.disableEditing=!0,c.newPlans[a.ind]=a,c.cleanPlan()},c.addPlanValidation=function(){var a=c.plan,b=a.description;return!(a.fromDate>0&&(a.tillDate>0||"permanent"===a.tillDate)&&a.duration>0&&a.interest>0&&b.constructor===Object&&Object.keys(b).length>0)},c.createInSystem=function(){g.validate("newPlanCreation","cancel",function(){var a=c.newPlans.length;c.newPlans.forEach(function(d){delete d.ind,0===--a&&f.create({plan:c.newPlans,userID:h,sessID:i},function(a){if(c.newPlans=[],a.result)g.response("success","operationSuccess");else switch(a.reason){case"invalid_sessid":g.response("failure","invalidSession",function(){b.path($LOGOUT).replace()});break;case"permission_denied":g.response("failure","permissionDenied",function(){b.path($LOGOUT).replace()})}})})},function(){})}}]),wmoControllers.controller("CreateUserCtrl",["$window","$rootScope","$scope","$routeParams","$location","$uibModal","CreateUser","FilterSortTranslated","Enroll",function(a,b,c,d,e,f,g,h,i){var j=$LOGIN,k=$USERS,l=$REGISTER,m=!1,n=["passwd","personalDetails","bankAccounts","submit"],o=Number(d.step);c.disabled=function(){switch(n[o]){case"passwd":return c.validatePasswd&&(b.password=c.password),!((b.password||"").length>0&&b.password===c.passConfirm);case"personalDetails":return!((b.user.firstName||"").length>0&&(b.user.familyName||"").length>0&&(b.user.city||"").length>0&&"ok"===c.phoneIsValid());case"bankAccounts":return!((b.user.bankAccounts||[]).length>0);default:return!1}};var p=function(){var d=b.user,f=b.password,h=b.email;g.get({email:h,password:f,user:d},function(d){return d.result&&(a.sessionStorage.setItem("sessID",d.sessID),a.sessionStorage.setItem("userID",d.userID),k=k+d.userID+"/"+d.sessID,e.path(k).replace(),delete b.password,b.user={}),c.response=d})};b.email=a.sessionStorage.getItem("email"),b.user=b.user||{language:b.lang.lang},b.userPhone=b.userPhone||"",c.bankAccounts=b.user.bankAccounts||[],c.cityInput=b.user.city?b.lang.tr(b.user.city):"",c.countries=Object.keys($COUNTRIES),c.password="",c.class={phoneNumberClass:""},c.phoneAlertMessage="phone_already_exists",c.validatePasswd=function(){return passwdValidateRE.test(c.password)},c.validatePhoneNumber=function(){return phoneNumberValidateRE.test(b.user.phone)},c.showPhoneAlert=function(){return m},c.dismissPhoneAlert=function(){m=!1,delete b.user.phone,c.class.phoneNumberClass=""},c.phoneIsValid=function(){return b.userPhone===b.user.phone?"ok":!m&&c.validatePhoneNumber()&&b.userPhone!==b.user.phone?"alert":c.validatePhoneNumber()||m?"continue":"usage"},c.enrollPhoneNumber=function(){i.checkPhone({phone:b.user.phone},function(a){a.result?(m=!1,b.userPhone=b.user.phone):(b.userPhone="",m=!0,c.phoneAlertMessage=a.reason||"no_reason")})},c.setCountry=function(a){var a=a||b.user.country||c.countries[0];c.country=a,c.countryCode=$COUNTRIES[a].countryCode,c.phoneExample=$COUNTRIES[a].phoneExample,c.currency=b.lang.tr($COUNTRIES[a].currency.name)+"    "+$COUNTRIES[a].currency.sign,c.cities=$COUNTRIES[a].cityList,b.user.country=a,b.user.currency=$COUNTRIES[a].currency.value},c.setCity=function(a){c.cityInput=b.lang.tr(a),b.user.city=a},c.cityList=function(a){return h($COUNTRIES[c.country].cityList,a)},c.openBankAccountManager=function(a){var d=f.open({animation:!0,keyboard:!0,backdrop:"static",templateUrl:$TMPL+"manageBankAccount.html",controller:"ModalManageBankAccountCtrl",size:"md",resolve:{bankAccounts:function(){return c.bankAccounts},country:function(){return b.user.country},openValue:function(){return a||""}}});d.result.then(function(a){b.user.bankAccounts=a.concat()},function(){})},c.nextStr=o===n.length-1?"submit":"next",c.backStr=0===o?"cancel":"back",c.show=function(a){return o===n.indexOf(a)},c.next=function(){var a=o+1;a<=n.length-1?e.path(l+a).replace():p()},c.back=function(){var a=o-1;a<0?e.path(j).replace():e.path(l+a).replace()}}]),wmoControllers.controller("EnrollCtrl",["$window","$scope","$rootScope","$uibModal","$location","Enroll",function(a,b,c,d,e,f){b.enroll=function(c){var d=a.sessionStorage.getItem("lang")||"eng";f.checkEmail({email:c,lang:d},function(a){return a.result&&b.openModal(),b.response=a})},b.openModal=function(){var c=d.open({animation:!0,keyboard:!0,backdrop:"static",templateUrl:$TMPL+"enroll.html",controller:"ModalEnrollCtrl",size:"md",resolve:{Email:function(){return b.email}}});c.result.then(function(b){a.sessionStorage.setItem("email",b),e.path($REGISTER+$START).replace()},function(){a.sessionStorage.setItem("email","")})},b.showAlert=function(){return void 0!==(b.response||{}).reason&&(b.response.reason&&(b.inputChanged=!1),!!b.response.reason)},b.dismissAlert=function(){return delete b.email,b.response.reason=!1},b.alertMessage=function(){return(b.response||{}).reason||"no_reason"},b.changed=function(){return b.inputChanged=!0},b.disabled=function(){return!(b.email&&b.inputChanged)}}]),wmoControllers.controller("GetPlansCtrl",["$window","$scope","$rootScope","$location","GetPlans","Calendar","ValidateByPassword","OperatePlan",function(a,b,c,d,e,f,g,h){var i=c.operand,j=f.today(),k=a.sessionStorage.getItem("userID")||"",l=a.sessionStorage.getItem("sessID")||"",m={getActive:"activePlans",getCompleted:"completedPlans",getPending:"pendingPlans",getPermanent:"permanentPlans",getAll:"allPlans"};b.plan={description:{}},b.editPlan=!1,b.dateFormat=$PLANPROPERTIES.planDateFormat,b.plansToDelete=b.plansToDelete||[],b.planList=b.planList||[],b.getPlanList=function(){e[i]({userID:k,sessID:l},function(a){if(a.result)b.planList=a.plans;else switch(a.reason){case"sessid_expired":g.validate("sessionExpired","logout",function(){e[i]({userID:k,sessID:l},function(a){b.planList=a.plans})},function(){d.path($LOGOUT).replace()});break;case"invalid_sessid":g.response("failure","invalidSession",function(){d.path($LOGOUT).replace()})}})},b.localTime=function(a){return f.local(a)},b.getPageHeader=function(){return m[i]},b.checkboxToDelete=function(a,c){var d=b.planList[c].planID;return a?b.plansToDelete.push(d):void(b.plansToDelete=b.plansToDelete.filter(function(a){return a!==d}))},b.showTrashTD=function(){return b.planList.filter(function(a){return a.fromDate>j}).length>0},b.disableCheckbox=function(a){return b.planList[a].fromDate<=j},b.cleanToDelete=function(){b.cleanDelete=!1,b.plansToDelete=[]},b.deleteFromSystem=function(){g.validate("removingPlans","cancel",function(){h.remove({planID:b.plansToDelete,userID:k,sessID:l},function(a){if(b.plansToDelete=[],b.cleanDelete=!1,a.result)e[i]({userID:k,sessID:l},function(a){b.planList=a.plans}),g.response("success","operationSuccess");else switch(a.reason){case"invalid_sessid":g.response("failure","invalidSession",function(){d.path($LOGOUT).replace()});break;case"permission_denied":g.response("failure","permissionDenied",function(){d.path($LOGOUT).replace()})}})},function(){})},b.editPlan=function(a){b.plan=JSON.parse(JSON.stringify(b.planList[a])),b.planEditing=!0,b.planPropertiesTmpl=c.planPropertiesTmpl+"?r="+Math.random()},b.cancelEditing=function(){b.planEditing=!1,b.plan={description:{}}},b.doneEditing=function(){var a=b.plan;delete a.ind,g.validate("updatingPlan","cancel",function(){h.update({plan:a,userID:k,sessID:l},function(a){if(b.plansToDelete=[],b.cleanDelete=!1,a.result)b.planEditing=!1,b.plan={description:{}},e[i]({userID:k,sessID:l},function(a){b.planList=a.plans}),g.response("success","operationSuccess");else switch(a.reason){case"invalid_sessid":g.response("failure","invalidSession",function(){d.path($LOGOUT).replace()});break;case"permission_denied":g.response("failure","permissionDenied",function(){d.path($LOGOUT).replace()})}})},function(){})}}]),wmoControllers.controller("LoginCtrl",["$window","$scope","$location","Login",function(a,b,c,d){var e=$USERS;b.login=function(f,g){d.get({email:f,password:g},function(d){return d.result&&(a.sessionStorage.setItem("sessID",d.sessID),a.sessionStorage.setItem("userID",d.userID),a.sessionStorage.setItem("email",f),e=e+d.userID+"/"+d.sessID,c.path(e).replace()),b.response=d})},b.showAlert=function(){return void 0!==(b.response||{}).reason&&(b.response.reason&&(b.inputChanged=!1),!!b.response.reason)},b.dismissAlert=function(){return delete b.password,b.response.reason=!1},b.alertMessage=function(){return(b.response||{}).reason||"no_reason"},b.changed=function(){return b.inputChanged=!0},b.disabled=function(){return!(b.email&&b.password&&b.inputChanged)}}]),wmoControllers.controller("LogoutCtrl",["$window","$location","$rootScope","Logout",function(a,b,c,d){var e=a.sessionStorage.getItem("sessID");d.get({sessID:e},function(d){a.sessionStorage.setItem("sessID",""),a.sessionStorage.setItem("userID",""),a.sessionStorage.setItem("email",""),delete c.user,b.path($LOGIN).replace()})}]),wmoControllers.controller("ModalEnrollCtrl",["$scope","$rootScope","$uibModalInstance","Enroll","Email",function(a,b,c,d,e){var f=e,g=!1;a.input={verNumber:"",verString:"",verNumberClass:"",verStringClass:""},a.validateNumber=function(){return a.input.verNumber.match(/^[0-9]{8}$/)},a.validateString=function(){return a.input.verString.match(/^[a-z]{8}$/)},a.disabled=function(){return!(a.validateString()&&a.validateString()&&!a.hideInput)},a.showAlert=function(){return g},a.dismissAlert=function(){g=!1,a.input.verNumber="",a.input.verString="",a.input.verNumberClass="",a.input.verStringClass=""},a.register=function(){d.reassert({email:f,number:a.input.verNumber,string:a.input.verString},function(a){a.result?c.close(f):g=!0})},a.cancel=function(){c.dismiss("canceled")}}]),wmoControllers.controller("ModalLogoutCtrl",["$scope","$uibModalInstance",function(a,b){a.logout=function(){b.close("logout")},a.cancel=function(){b.dismiss("canceled")}}]),wmoControllers.controller("ModalManageBankAccountCtrl",["$scope","$uibModalInstance","FilterSortTranslated","bankAccounts","country","openValue",function(a,b,c,d,e,f){var e=e,f=f,g={};a.bankAccounts=d,a.btnName="add",a.removeBankAccount=function(b){a.bankAccounts.splice(b,1)},a.createBankList=function(){a.bankList=c($COUNTRIES[e].bankList),a.bankName=g.bank=a.bankList[0]};var h=function(b){return function(){a.bankAccounts[b]=JSON.parse(JSON.stringify(g)),a.cleanAndClose()}},i=function(){a.bankAccounts.push({bank:g.bank,branch:g.branch,account:g.account,accountOwner:g.accountOwner}),a.cleanAndClose()},j=function(){return!(g.branch&&g.account&&g.accountOwner)};a.setBankName=function(a){g.bank=a},a.setBankBranch=function(a){g.branch=a},a.setBankAccount=function(a){g.account=a},a.setAccountOwner=function(a){g.accountOwner=a},a.editBankAccout=function(b){g=JSON.parse(JSON.stringify(a.bankAccounts[b])),a.bankName=g.bank,a.bankBranch=g.branch,a.bankAccount=g.account,a.accountOwner=g.accountOwner,a.bankAccountFormTmpl="BankAccountFormTmpl.html",a.btnFunction=h(b),a.disabledAdd=function(){return!1},a.btnSign="ok",a.btnClass="primary"},a.addBankAccount=function(){a.bankAccountFormTmpl="BankAccountFormTmpl.html",a.btnFunction=i,a.disabledAdd=j,a.btnSign="plus",a.btnClass="success"},a.cleanAndClose=function(){delete a.bankName,delete a.bankBranch,delete a.bankAccount,delete a.accountOwner,delete a.bankAccountFormTmpl,g={}},a.isFormOpened=function(){return!!a.bankAccountFormTmpl},a.initAddAccount=function(){"add"===f&&a.addBankAccount()},a.disabled=function(){return 0===a.bankAccounts.length},a.done=function(){b.close(a.bankAccounts)},a.cancel=function(){b.dismiss("canceled")}}]),wmoControllers.controller("ModalOperationResponseCtrl",["$scope","$uibModalInstance","modalHeader","modalStatus",function(a,b,c,d){switch(a.operModal={title:c},d){case"success":a.operModal.glyphicon="glyphicon-ok-circle",a.operModal.alert="alert-success";break;case"failure":a.operModal.glyphicon="glyphicon-ban-circle",a.operModal.alert="alert-danger"}a.close=function(){b.close("confirmed")},a.cancel=function(){b.dismiss("canceled")}}]),wmoControllers.controller("ModalValidateByPasswordCtrl",["$window","$scope","$uibModalInstance","Validate","modalHeader","modalCancel",function(a,b,c,d,e,f){b.modalHeader=e,b.modalCancel=f;var g=function(){return passwdValidateRE.test(b.data.password)},h={},i=!0,j=a.sessionStorage.getItem("email"),k=a.sessionStorage.getItem("sessID");b.data={email:j,sessID:k},b.showAlert=function(){return void 0!==h.reason&&(h.reason&&(i=!1),!!h.reason)},b.dismissAlert=function(){return delete b.data.password,h.reason=!1},b.alertMessage=function(){return"invalid_credentials"===h.reason&&(h.reason="wrong_password"),h.reason||"no_reason"},b.changed=function(){return i=!0},b.disabled=function(){return!(g()&&i)},b.confirm=function(){d.get(b.data,function(a){return a.result&&c.close("confirmed"),h=a})},b.cancel=function(){c.dismiss("canceled")}}]),wmoControllers.controller("PlanPropertiesCtrl",["$scope","$rootScope","Calendar","LangMngr",function(a,b,c,d){function e(){var b=a.plan.fromDate;return b<=f?c.dayPeriod(b,f)>i?h:i+h-c.dayPeriod(b,f):c.dayPeriod(f,b)+i}var f=c.today(),g=$PLANPROPERTIES.pendingStartPeriod,h=$PLANPROPERTIES.pendingFinishPeriod,i=$PLANPROPERTIES.minActivePeriod,j=i,k=5,l=$PLANPROPERTIES.maxPlanDuration,m=$PLANPROPERTIES.maxPlanPercentage;a.percentageLength=k,a.maxPlanDuration=l,a.tillDateInput="init",a.minFromDate=g,a.minTillDate=g+i,a.setInputLang=function(){a.dr={},$LANGS.forEach(function(b){var c=b.value,e=d.getDirection(c);a.dr[c]={},a.dr[c].Dir=e,a.dr[c].FltDir=d.getFloatDirection(e),a.dr[c].OppFltDir=d.getOppositeFloatDirection(e)})},"undefined"==typeof a.plan.fromDate?(a.fromDate=c.yyyyMMdd(c.addDays(f,g),"-"),a.plan.fromDate=c.utc(a.fromDate).getTime()):(a.fromDate=c.yyyyMMdd(a.plan.fromDate,"-"),a.tillDate=c.yyyyMMdd(c.addDays(a.fromDate,i),"-")),"undefined"==typeof a.plan.tillDate?(a.tillDate=c.yyyyMMdd(c.addDays(f,g+i),"-"),a.plan.tillDate=c.utc(a.tillDate).getTime()):(a.minTillDate=e(),"permanent"===a.plan.tillDate?(a.tillDateInput="unlimited",a.tillDate=c.yyyyMMdd(c.addDays(f,a.minTillDate),"-")):(a.tillDateInput="date",a.tillDate=c.yyyyMMdd(a.plan.tillDate,"-"),j=c.dayPeriod(a.plan.fromDate,a.plan.tillDate))),a.setFromDate=function(b){var b=c.utc(b),d=c.addDays(b,i);a.plan.fromDate=b.getTime(),a.minTillDate=i+c.dayPeriod(f,b),a.tillDateInput="init",j>0&&(d=c.addDays(b,j)),a.tillDate=c.yyyyMMdd(d,"-")},a.setTillDate=function(b){var b=c.utc(b);a.plan.tillDate=b.getTime(),j=c.dayPeriod(a.plan.fromDate,a.plan.tillDate)},a.setTillDateInput=function(b){a.tillDateInput=b,"unlimited"===b&&(a.plan.tillDate="permanent"),"date"===b&&(a.plan.tillDate=c.utc(a.tillDate).getTime())},a.validatePercentage=function(b){return 0===b.length&&(a.percentageLength=k),b.match(/,$/)&&(b=b.replace(/,$/,".")),b.match(/^\./)&&(b=b.replace(/^\./,"0."),a.percentageLength=k-1),b.match(/\..*\.$/)&&(b=b.slice(0,-1)),b.match(/[\d\.]$/)||(b=b.slice(0,-1)),Number(b)>m&&(b=b.slice(0,-1)),b},a.validateDuration=function(a){return a.match(/[\d]$/)||(a=a.slice(0,-1)),(Number(a)<1||Number(a)>l)&&(a=a.slice(0,-1)),a},a.enableProperties=function(){return"undefined"==typeof a.plan.fromDate||"undefined"==typeof a.plan.tillDate||a.plan.fromDate>f},a.enableActivePeriod=function(){return"undefined"==typeof a.plan.fromDate||"undefined"==typeof a.plan.tillDate||("permanent"===a.plan.tillDate||a.plan.tillDate>f)},a.disableFromDate=function(){return"undefined"!=typeof a.plan.fromDate&&a.plan.fromDate<=f}}]),wmoControllers.controller("setLangCtrl",["$rootScope","$scope","LangMngr",function(a,b,c){a.lang=c.init(),a.setLang=function(a){c.setLang(a)},b.langs=$LANGS,b.langsBar=function(){var b;return $LANGS.forEach(function(c){c.value===a.lang.lang&&(b=c.name)}),b.slice(0,3)}}]),wmoControllers.controller("UserHomeCtrl",["$location","$window","$routeParams","$rootScope","$scope","$uibModal","GetUser","ValidateByPassword",function(a,b,c,d,e,f,g,h){var i=c.userid||"",j=c.sessid||"";e.userID=b.sessionStorage.getItem("userID")||"",e.sessID=b.sessionStorage.getItem("sessID")||"",e.userID.length>0&&e.sessID.length>0&&i===e.userID&&j===e.sessID||a.path($LOGOUT).replace();var k=function(){g.get({userID:e.userID,sessID:e.sessID},function(b){if(b.result)d.user=b.user,e.currencySign=$COUNTRIES[d.user.country].currency.sign;else switch(b.reason){case"invalid_sessid":a.path($LOGOUT).replace();break;case"sessid_expired":h.validate("sessionExpired","logout",function(){g.get({userID:e.userID,sessID:e.sessID},function(a){d.user=a.user,e.currencySign=$COUNTRIES[d.user.country].currency.sign})},function(){a.path($LOGOUT).replace()})}return e.response=b})},l={init:"LoanCollect",userInfo:"UserInfo",loanCollect:"LoanCollect",createPlan:"CreatePlan",getPlans:"GetPlans",test:"test"},m=function(a,b){var b=b||"";e.userHomeIncludeURL=$UHTMPL+l[a]+".html",b.length>0&&(e.userHomeIncludeURL+="?operand="+b+"&r="+Math.random(),d.operand=b)};e.setIncludeURL=m,e.initUserHome=function(){0===((d.user||{}).userID||"").length&&k(),0===(e.userHomeIncludeURL||"").length&&m("init")},e.logout=function(){var b=f.open({animation:!0,keyboard:!0,backdrop:"static",templateUrl:$TMPL+"logout.html",controller:"ModalLogoutCtrl",size:"sm",resolve:{}});b.result.then(function(){a.path($LOGOUT).replace()},function(){})}}]);